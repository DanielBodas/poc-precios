<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n ‚Äî PriceTracker Pro</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="/css/main.css">
</head>

<body>
    <div class="container animate-in">
        <header style="margin-bottom: 2rem;">
            <h1 class="page-title">Sistema</h1>
            <!-- Admin Internal Tabs - Mobile Friendly -->
            <div
                style="background: rgba(0,0,0,0.03); padding: 0.5rem; border-radius: 16px; display: flex; gap: 0.5rem;">
                <button class="admin-tab-btn active" onclick="switchSection('sec-db')">Infra</button>
                <button class="admin-tab-btn" onclick="switchSection('sec-prods')">Cat√°logo</button>
                <button class="admin-tab-btn" onclick="switchSection('sec-map')">Mapeo</button>
            </div>
        </header>

        <main>
            <!-- SECCI√ìN 1: INFRAESTRUCTURA -->
            <section id="sec-db" class="admin-section active">
                <div class="grid-2">
                    <div class="card">
                        <label>A√±adir Categor√≠a</label>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <input id="in-cat" type="text" placeholder="Ej: Bebidas">
                            <button onclick="quickAdd('Categoria','in-cat')"
                                style="width: auto; padding: 0 1rem;">+</button>
                        </div>
                        <div id="list-cats" style="margin-top: 1rem; max-height: 200px; overflow-y: auto;"></div>
                    </div>

                    <div class="card">
                        <label>A√±adir Marca</label>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <input id="in-marca" type="text" placeholder="Ej: Nestl√©">
                            <button onclick="quickAdd('Marca','in-marca')"
                                style="width: auto; padding: 0 1rem;">+</button>
                        </div>
                        <div id="list-marcas" style="margin-top: 1rem; max-height: 200px; overflow-y: auto;"></div>
                    </div>

                    <div class="card">
                        <label>Nuevo Supermercado</label>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <input id="in-super" type="text" placeholder="Ej: Aldi">
                            <button onclick="quickAdd('Supermercado','in-super')"
                                style="width: auto; padding: 0 1rem;">+</button>
                        </div>
                        <div id="list-supers" style="margin-top: 1rem; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
            </section>

            <!-- SECCI√ìN 2: CAT√ÅLOGO PRODUCTORES -->
            <section id="sec-prods" class="admin-section" style="display: none;">
                <div class="card" style="margin-bottom: 2rem;">
                    <label>Crear Producto Maestro</label>
                    <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 0.5rem;">
                        <input id="p-name" type="text" placeholder="Nombre (ej: Yogur Griego)">
                        <div class="grid-2">
                            <select id="p-cat"></select>
                            <input id="p-units" type="text" placeholder="kg,g o ud">
                        </div>
                        <button onclick="createMasterProduct()">A√±adir al Cat√°logo</button>
                    </div>
                </div>

                <input type="text" id="p-search" placeholder="üîç Buscar productos..." onkeyup="filterP()"
                    style="margin-bottom: 1rem;">
                <div id="catalog-list" class="grid-2"></div>
            </section>

            <!-- SECCI√ìN 3: MAPEO INTELIGENTE -->
            <section id="sec-map" class="admin-section" style="display: none;">
                <div class="card" style="margin-bottom: 2rem; border-color: var(--primary);">
                    <label>Vincular Marca a Producto</label>
                    <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem;">
                        <select id="rel-p"></select>
                        <select id="rel-m"></select>
                        <button onclick="linkPM()">Establecer Relaci√≥n</button>
                    </div>
                </div>

                <div id="rel-viewer" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
            </section>
        </main>
    </div>

    <style>
        .admin-section {
            animation: fadeIn 0.3s ease-out;
        }

        .row-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #fff;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(0, 0, 0, 0.03);
            font-size: 0.9rem;
        }

        .pill {
            background: rgba(99, 102, 241, 0.08);
            color: var(--primary);
            padding: 0.25rem 0.6rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>

    <script src="/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/components.js"></script>
    <script>
        let allProds = [];

        async function init() {
            try {
                const [cats, marcas, supers, prods] = await Promise.all([
                    ApiService.getCatalogCategorias(),
                    ApiService.getCatalogMarcas(),
                    ApiService.getCatalogSupermercados(),
                    ApiService.getCatalogProductos()
                ]);

                allProds = prods;

                renderList("list-cats", cats, 'deleteCategoria');
                renderList("list-marcas", marcas, 'deleteMarca');
                renderList("list-supers", supers, 'deleteSupermercado');
                renderCatalog(prods);
                renderMap(prods);

                const pop = (id, items) => {
                    const el = document.getElementById(id);
                    el.innerHTML = items.sort((a, b) => a.nombre.localeCompare(b.nombre)).map(i => `<option value="${i.id}">${i.nombre}</option>`).join('');
                };
                pop('p-cat', cats);
                pop('rel-p', prods);
                pop('rel-m', marcas);
            } catch (e) { console.error(e); }
        }

        function switchSection(id) {
            document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).style.display = 'block';
            event.target.classList.add('active');
        }

        function renderList(id, items, method) {
            const container = document.getElementById(id);
            container.innerHTML = items.map(i => `
                <div class="row-item">
                    <span>${i.nombre}</span>
                    <button onclick="handleDel(${i.id},'${method}')" style="background:transparent; color: #ef4444; width:auto; padding:0;"><i data-lucide="x-circle" style="width:18px;"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderCatalog(items) {
            const container = document.getElementById("catalog-list");
            container.innerHTML = items.map(p => `
                <div class="card" style="padding: 1rem;">
                    <div style="font-weight: 800; color: var(--primary);">${p.nombre}</div>
                    <div style="font-size: 0.65rem; color: var(--text-muted); text-transform:uppercase;">${p.unidades_permitidas || 'Cualquiera'}</div>
                    <button onclick="handleDel(${p.id},'deleteProducto')" style="margin-top: 0.75rem; background:rgba(239,68,68,0.05); color:#ef4444; padding:0.5rem; font-size:0.8rem;">Borrar</button>
                </div>
            `).join('');
        }

        function renderMap(prods) {
            const container = document.getElementById("rel-viewer");
            container.innerHTML = prods.map(p => `
                <div class="card" style="padding: 1rem;">
                    <div style="font-weight: 700; margin-bottom: 0.5rem;">${p.nombre}</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${p.marcas.map(m => `
                            <div class="pill">${m.nombre}<button onclick="unlink(${p.id},${m.id})" style="background:transparent; color:#ef4444; width:auto; padding:0; height:auto;">√ó</button></div>
                        `).join('') || '<span style="font-size:0.7rem; font-style:italic;">Sin marcas</span>'}
                    </div>
                </div>
            `).join('');
        }

        async function quickAdd(type, inputId) {
            const val = document.getElementById(inputId).value;
            if (!val) return;
            await ApiService[`create${type}`](val);
            document.getElementById(inputId).value = "";
            init();
        }

        async function createMasterProduct() {
            const n = document.getElementById("p-name").value;
            const c = document.getElementById("p-cat").value;
            const u = document.getElementById("p-units").value;
            if (!n) return;
            await ApiService.createProducto(n, c, u);
            init();
        }

        async function linkPM() {
            await ApiService.linkProductoMarca(document.getElementById("rel-p").value, document.getElementById("rel-m").value);
            init();
        }

        async function unlink(pId, mId) {
            await ApiService.unlinkProductoMarca(pId, mId);
            init();
        }

        async function handleDel(id, method) {
            if (!confirm("¬øEliminar?")) return;
            await ApiService[method](id);
            init();
        }

        function filterP() {
            const q = document.getElementById("p-search").value.toLowerCase();
            const filtered = allProds.filter(p => p.nombre.toLowerCase().includes(q));
            renderCatalog(filtered);
        }

        document.addEventListener("DOMContentLoaded", init);
    </script>
</body>

</html>
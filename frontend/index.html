<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Actividad — PriceTracker Pro</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="/css/main.css">
    <style>
        .feed-item {
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
            background: white;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            border: 1px solid var(--glass-border);
            position: relative;
        }

        .feed-date {
            min-width: 60px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-right: 1px solid var(--glass-border);
            padding-right: 1.5rem;
        }

        .day {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .month {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .feed-content {
            flex: 1;
        }

        .price-badge {
            background: rgba(99, 102, 241, 0.05);
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-weight: 800;
            color: var(--primary);
            font-size: 1.25rem;
            display: inline-flex;
            align-items: baseline;
            gap: 2px;
        }

        .action-btns {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        @media (max-width: 600px) {
            .feed-item {
                flex-direction: column;
                gap: 1rem;
            }

            .feed-date {
                border-right: none;
                border-bottom: 1px solid var(--glass-border);
                padding: 0 0 1rem 0;
                flex-direction: row;
                gap: 0.5rem;
                min-width: auto;
                justify-content: flex-start;
            }

            .day {
                font-size: 1.2rem;
            }

            .month {
                font-size: 1.2rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1 class="page-title">Muro de Actividad</h1>
            <p style="color: var(--text-muted); margin-bottom: 2rem;">Últimos precios registrados en tu red. Mantente al
                día de las variaciones del mercado.</p>
        </header>

        <main id="feed-container">
            <!-- Items de actividad dinámicos -->
        </main>
    </div>

    <!-- Scripts -->
    <script src="/config.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/components.js"></script>
    <script>
        async function cargarFeed() {
            const container = document.getElementById("feed-container");

            // Skeleton
            container.innerHTML = Array(4).fill(0).map(() => `
                <div class="card skeleton" style="height: 120px; margin-bottom: 1rem;"></div>
            `).join('');

            try {
                const datos = await ApiService.getPrecios();
                container.innerHTML = "";

                if (datos.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i data-lucide="bell-off" style="width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p>No hay actividad reciente. Empieza a registrar tus compras.</p>
                        </div>
                    `;
                    return;
                }

                datos.forEach(p => {
                    const date = new Date(p.fecha);
                    const day = date.getDate();
                    const month = date.toLocaleDateString('es-ES', { month: 'short' });

                    const item = document.createElement("div");
                    item.className = "feed-item";
                    item.innerHTML = `
                        <div class="feed-date">
                            <span class="day">${day}</span>
                            <span class="month">${month}</span>
                        </div>
                        <div class="feed-content">
                            <div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.25rem;">
                                <span class="badge badge-info">${p.categoria}</span>
                                ${p.es_oferta ? '<span class="badge" style="background:#fef3c7; color:#92400e; border: 1px solid #fde68a;">OFERTA</span>' : ''}
                            </div>
                            <h3 style="font-weight:800; font-size:1.1rem; color:var(--text-dark);">${p.producto}</h3>
                            <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:0.75rem;">
                                ${p.marca} en <strong>${p.supermercado}</strong> — ${p.cantidad}${p.unidad}
                            </p>
                            <div class="price-badge" title="Precio x ${p.unidad}">
                                ${p.precio_unidad.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 3 })}<span style="font-size:0.8rem;">€ / ${p.unidad}</span>
                            </div>
                        </div>
                        <div class="action-btns">
                            <button onclick="location.href='add.html?id=${p.id}'" style="background:rgba(99,102,241,0.1); border:none; color:var(--primary); padding:0.5rem; border-radius:8px; cursor:pointer;">
                                <i data-lucide="edit-3" style="width:16px; height:16px;"></i>
                            </button>
                            <button onclick="eliminar(${p.id})" style="background:rgba(239,68,68,0.1); border:none; color:#ef4444; padding:0.5rem; border-radius:8px; cursor:pointer;">
                                <i data-lucide="trash-2" style="width:16px; height:16px;"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(item);
                });
                lucide.createIcons();
            } catch (error) {
                container.innerHTML = `<div class="empty-state" style="color:#ef4444;">Error de conexión</div>`;
            }
        }

        async function eliminar(id) {
            if (!confirm("¿Borrar este registro?")) return;
            await ApiService.deletePrecio(id);
            cargarFeed();
        }

        document.addEventListener("DOMContentLoaded", cargarFeed);
    </script>
</body>

</html>